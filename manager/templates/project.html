<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>sassycode - project</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div class="container">
      <a href="/">← All projects</a>
      <h1>{{ project.name }} <a href="/projects/{{ project.id }}/edit" style="font-size:14px; margin-left:8px;">Edit</a></h1>
      <p><code>{{ project.path }}</code></p>

      <div class="grid-split">
        <div class="panel">
          <h2>Trigger Scan</h2>
          <form class="toolbar" method="post" action="/scans">
            <input type="hidden" name="project_id" value="{{ project.id }}" />
            <select name="model" required>
              <option value="gpt-5">gpt-5</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
            </select>
            <label class="muted" style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" name="deep" value="1" /> Deep analysis
            </label>
            <button class="btn-primary" type="submit">Run Scan</button>
          </form>
        </div>
        <div class="panel scroll-panel">
          <h2>Scans</h2>
          <ul class="list">
            {% for s in scans %}
            <li>
              <a href="/scans/{{ s.id }}">Scan #{{ s.id }}</a>
              <span class="badge" style="margin-left:8px;">{{ s.status }}</span>
              <span class="muted">{{ s.model }}</span>
            </li>
            {% else %}
            <li class="muted">No scans yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <h2>Unique Findings</h2>
      <div class="toolbar">
        <input type="search" id="uniqSearch" placeholder="Search findings..." />
        <select id="uniqSort">
          <option value="last_seen_desc" selected>Sort: Last seen (newest)</option>
          <option value="last_seen_asc">Sort: Last seen (oldest)</option>
          <option value="severity_desc">Sort: Severity (high→low)</option>
          <option value="severity_asc">Sort: Severity (low→high)</option>
          <option value="occ_desc">Sort: Occurrences (high→low)</option>
          <option value="occ_asc">Sort: Occurrences (low→high)</option>
          <option value="file_asc">Sort: File (A→Z)</option>
        </select>
      </div>
      {% set uniques = db.query(models.UniqueFinding).filter(models.UniqueFinding.project_id == project.id).order_by(models.UniqueFinding.last_seen_at.desc()).all() %}
      {% if uniques %}
      <table id="uniqTable">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Description</th>
            <th>CWE</th>
            <th>Function</th>
            <th>Entrypoint</th>
            <th>Occurrences</th>
            <th>Last seen</th>
            <th>File</th>
          </tr>
        </thead>
        <tbody>
        {% for u in uniques %}
          <tr data-severity="{{ (u.severity or u.last_severity or 'LOW') }}" data-occ="{{ u.occurrences or 1 }}" data-file="{{ u.file_path }}" data-lastseen="{{ u.last_seen_at.isoformat() if u.last_seen_at else '' }}">
            <td><span class="badge sev-{{ u.severity or u.last_severity or 'LOW' }}">{{ u.severity or u.last_severity or 'LOW' }}</span></td>
            <td>{{ u.description or u.last_description or '-' }}</td>
            <td>{{ u.cwe or '-' }}</td>
            <td><code>{{ u.function_name or '-' }}</code></td>
            <td><code>{{ u.entrypoint or '-' }}</code></td>
            <td>{{ u.occurrences or 1 }}</td>
            <td>{{ u.last_seen_at }}</td>
            <td><code>{{ u.file_path }}</code></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">No unique findings yet.</p>
      {% endif %}
    </div>
    <script src="/static/app.js"></script>
  </body>
  </html>


